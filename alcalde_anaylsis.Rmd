---
title: "Sedation with Benzodiazepines in MICU"
subtitle: "Analysis for Alcalde"
author: "Elizabeth Franco, Jen Cortes"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
library(BGTools)
library(pander)
library(FSA)
library(dplyr)
library(purrr)
if (!exists("data.demograph")) data.demograph <- readRDS("Analysis/data_demograph.Rds")
if (!exists("data.assessments")) data.assessments <- readRDS("Analysis/data_assessments.Rds")
if (!exists("data.lfts")) data.lfts <- readRDS("Analysis/data_lfts.Rds")
if (!exists("data.sedatives")) data.sedatives <- readRDS("Analysis/data_sedatives.Rds")
```

#### Continuous Data

Shapiro-Wilk normality test is performed and if the data is not normally distributed (the p-value is < 0.05), then the Mann-Whitney test is used to compare the medians of the groups.

If the data is normally distributed, an F-test is performed to determine if the groups have equal variances (p-value is $\ge$ 0.05) and then the appropriate t-test (with or without equal variances) is used to compare the means of the my.groups.

#### Categorical Data

Data is evaluated using the Chi-squared test. 

## Results

```{r echo=FALSE, warning=FALSE}
temp <- data.demograph %>%
    mutate(group = ifelse(bzd == TRUE, "BZD", "No BZD"))
my.group <- temp$group
temp <- select(temp, -pie.id, -bzd, -diagnosis)

results <- analyze_data(temp)
pander(results)
```

## Sedatives

```{r echo=FALSE, warning=FALSE}
sed <- data.sedatives %>% 
    mutate(group = factor(ifelse(bzd == TRUE, "BZD", "No BZD"))) %>%
    select(med, group, time.wt.avg.rate:total.dose) 

sed.split <- sed %>%
    split(.$med)

grp <- sed.split$dexmedetomidine$group

smry <- lapply(sed.split$dexmedetomidine, tapply, grp, Summarize)
res <- lappy(smry, )

test <- lapply(sed.split$dexmedetomidine, function(x)
    tapply(x, grp, function(y) sum(!is.na(y)))
)

               
               # tapply, grp, function(x) sum(!is.na(x)))
test2 <- lapply(test, function(x) sum(x < 4))

test <- sed.split$dexmedetomidine %>%
    group_by(group) %>%
    summarise_each(~sum(!is.na(.))) 
    
cont <- sed %>% 
    slice_rows(c("med", "group")) %>%
    keep(is.numeric)

test2 <- lapply(sed.split$dexmedetomidine, function(x) split(x, grp))
test3 <- lapply(test2, function(x) sum(!is.na(x)))
    # map(analyze_data)
    # by_slice(analyze_data)

test <- lapply(sed, analyze_data)
res <- analyze_data(sed.split$dexmedetomidine)
res2 <- analyze_data(sed.split$propofol)

    cont <- sapply(sed, is.numeric)
    test <- my.data[,c(cont)]

    ds1 <- lapply(test, tapply, my.group, Summarize)


my.group <- sed$group

sed <- ungroup(sed) %>%
    select(med, time.wt.avg.rate:total.dose) %>%
    # slice_rows("med") %>%
    # by_slice(map, summary)
    # by_slice(analyze_data, my.group = my.group)

tmp <- filter(sed, med == "lorazepam") %>%
    analyze_data(my.group)

```



```{r}
library(purrr)
library(broom)

temp <- data.demograph %>%
    mutate(group = ifelse(bzd == TRUE, "BZD", "No BZD")) %>%
    group_by(group) %>%
    select(-bzd, -pie.id)



cont <- map_lgl(temp, is.numeric)

test <- keep(temp, is.numeric) %>% 
    bind_cols(select(temp, group)) %>% 
    # group_by(group) %>%
    # do(tidy(summary(.)))
    
    slice_rows("group") %>% 
    by_slice(map, summary)

test2 <- temp %>% split(.$group) %>% map(summary)

pander(test$.out)
```

## References

Data was processed using `r R.Version()$version.string` on a `r R.Version()$platform` system.

Prepared by: Brian Gulbis

```{r echo=FALSE}
citation()
```
